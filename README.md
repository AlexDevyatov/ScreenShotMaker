# Автоматическая генерация скриншотов Android-приложения на разных языках

Система получает **три скриншота главного экрана** одного и того же приложения — по одному на каждый язык (**ru-RU**, **en-US**, **es-ES**) — в формате PNG, используя Android-эмулятор в Docker.

## Требования на хосте

- **Docker**
- **KVM** (для Linux: `/dev/kvm`). Без KVM эмулятор будет работать в режиме программной эмуляции (медленнее).
- Никаких установленных Android SDK/ADB на хосте не требуется.

## Быстрый старт

1. Положите ваш `.apk` в каталог проекта (или укажите путь к нему).
2. Выполните на хосте:

```bash
chmod +x build-and-run.sh
./build-and-run.sh /путь/к/вашему/app-release.apk ./screenshots
```

3. После завершения в папке `./screenshots/` появятся:
   - `main_ru.png` — главный экран на русском
   - `main_en.png` — на английском
   - `main_es.png` — на испанском
   - (опционально) `screenshots.zip` — архив этих файлов

## Использование скриптов

### build-and-run.sh (на хосте)

- **Синтаксис:**  
  `./build-and-run.sh [путь_к_apk] [папка_для_скриншотов]`

- **Примеры:**

  ```bash
  ./build-and-run.sh
  # Использует ./app-release.apk и ./screenshots по умолчанию

  ./build-and-run.sh ./myapp.apk
  # APK: ./myapp.apk, скриншоты: ./screenshots

  ./build-and-run.sh /path/to/app.apk /path/to/output
  # Явно заданы APK и каталог вывода
  ```

- Скрипт:
  - Собирает Docker-образ с Android SDK и AVD (Pixel 5, Android 34, Google APIs x86_64).
  - Запускает контейнер с `--device /dev/kvm` и монтирует APK и папку для скриншотов.

### run.sh (внутри контейнера)

- Запускается как точка входа контейнера.
- Ожидает APK по пути `APK_PATH` (по умолчанию `/workspace/app.apk`).
- Для каждой локали (ru, en, es):
  - Меняет системную локаль через ADB (`persist.sys.locale` и др.), перезагружает эмулятор.
  - Устанавливает APK, запускает главную Activity, делает скриншот через `adb exec-out screencap -p`.
- Сохраняет файлы в `SCREENSHOTS_DIR` (по умолчанию `/screenshots`).
- По завершении останавливает эмулятор; при ошибках выполняет cleanup.

## Архитектура

| Компонент   | Назначение |
|------------|------------|
| **Dockerfile** | Ubuntu 22.04, Android SDK (command line tools), platform-tools (adb), emulator, system-image Android 34 (Google APIs x86_64), AVD «Pixel_5_API_34». |
| **run.sh**     | Запуск эмулятора в headless-режиме, ожидание загрузки, смена локали + перезагрузка, установка APK, запуск приложения, снятие скриншотов, завершение эмулятора. |
| **build-and-run.sh** | Сборка образа, запуск контейнера с монтированием APK и папки скриншотов и доступом к KVM. |

## Смена локали (Android 13/14)

В эмуляторе используется root-доступ ADB. Локаль задаётся так:

- `adb shell setprop persist.sys.locale <ru-RU|en-US|es-ES>`
- Дополнительно: `persist.sys.language`, `persist.sys.country`
- После смены локали выполняется **перезагрузка** (`adb reboot`), чтобы приложение получило новую локаль при старте.

Все временные данные и процессы — внутри контейнера; эмулятор по завершении останавливается.

## Обработка ошибок

- Если эмулятор не загрузится в течение **60 секунд** после старта, скрипт завершится с ошибкой.
- После смены локали ожидание загрузки ограничено **90 секундами**.
- При выходе (в том числе по ошибке) вызывается `adb emu kill` для корректного завершения эмулятора.

## Переменные окружения (в контейнере)

| Переменная      | По умолчанию           | Описание |
|-----------------|------------------------|----------|
| `APK_PATH`      | `/workspace/app.apk`   | Путь к APK внутри контейнера. |
| `SCREENSHOTS_DIR` | `/screenshots`      | Каталог для сохранения PNG. |
| `AVD_NAME`      | `Pixel_5_API_34`       | Имя AVD. |

## Веб-интерфейс

Запуск веб-сервера (APK через drag & drop):

```bash
python3 -m venv .venv
.venv/bin/pip install -r server/requirements.txt
.venv/bin/uvicorn server.main:app --host 0.0.0.0 --port 8080
```

Откройте в браузере `http://localhost:8080`, перетащите APK в зону загрузки. После завершения можно скачать скриншоты или архив.

## Развёртывание на сервере

На удалённом Linux-сервере (Ubuntu/Debian):

```bash
git clone <repo> && cd ScreenshotMaker
chmod +x deploy.sh
./deploy.sh
```

Скрипт установит Docker, Python, зависимости, соберёт образ и запустит systemd-сервис. Сервис будет доступен на порту **8080** (переменная `APP_PORT`).

**Подробная инструкция:** [DEPLOY.md](DEPLOY.md) — требования, шаги, настройка порта и Nginx, файрвол, обновление и устранение неполадок.

## Ограничения

- Поддерживается только **Android** (iOS не поддерживается).
- Локально доступен и **CLI**, и **веб-интерфейс**.
- Снимается только **стартовый экран** приложения (без сценариев логина, свайпов и т.п.).
- Главная Activity определяется из манифеста APK (launcher-activity); если её нет, используется `monkey` для запуска пакета.

## Лицензии

Используются официальные инструменты Google (Android SDK, ADB, emulator). Использование SDK подчиняется лицензии Android SDK.
